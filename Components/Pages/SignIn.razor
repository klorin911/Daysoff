@page "/signin"

@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using System.Security.Claims
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

@code {
    protected override async Task OnInitializedAsync()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        if (!query.TryGetValue("userId", out var userIdRaw) ||
            !Guid.TryParse(userIdRaw.ToString(), out var userId) ||
            !query.TryGetValue("email", out var emailRaw))
        {
            Nav.NavigateTo("/login");
            return;
        }

        var email = emailRaw.ToString();
        var returnUrl = query.TryGetValue("returnUrl", out var returnUrlRaw)
            ? returnUrlRaw.ToString()
            : "/";

        var claims = new List<Claim>
        {
            new(ClaimTypes.NameIdentifier, userId.ToString()),
            new(ClaimTypes.Email, email)
        };
        var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        var principal = new ClaimsPrincipal(identity);

        var http = HttpContextAccessor.HttpContext;
        if (http is not null)
        {
            await http.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);
        }

        Nav.NavigateTo(string.IsNullOrWhiteSpace(returnUrl) ? "/" : returnUrl);
    }
}
