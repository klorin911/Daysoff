@page "/schedule"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using DaysOff.Models
@using DaysOff.Services
@inject ScheduleService ScheduleService

<PageTitle>Schedule Selection</PageTitle>

<div class="selection-section">
    <div class="selection-header">
        <h2>Schedule Selection</h2>
        <p>Select your schedule, shift, and start month to preview the year ahead.</p>
    </div>
    
    <div class="selection-card">
        <div class="selection-fields">
            <div class="selection-field">
                <label class="form-label" for="schedule-type">Schedule</label>
                <select id="schedule-type" class="form-select" @bind="_selection.ScheduleType" @bind:after="UpdatePreview">
                    <option value="@ScheduleType.FiveByEight">5x8</option>
                    <option value="@ScheduleType.PlatoonTen">Platoon 10s</option>
                    <option value="@ScheduleType.RotatingFourByTen">Rotating 4x10</option>
                </select>
            </div>
            
            <div class="selection-field">
                <label class="form-label" for="shift-type">Shift</label>
                <select id="shift-type" class="form-select" @bind="_selection.ShiftType" @bind:after="UpdatePreview">
                    <option value="@ShiftType.Day">Day</option>
                    <option value="@ShiftType.Swing">Swing</option>
                    <option value="@ShiftType.Mid">Mid</option>
                </select>
            </div>
            
            <div class="selection-field">
                <label class="form-label" for="start-month">Start Month</label>
                <input id="start-month" class="form-control" type="month" value="@_selection.StartMonth.ToString("yyyy-MM")" @onchange="OnMonthChanged" />
            </div>

            @if (_selection.ScheduleType == ScheduleType.PlatoonTen)
            {
                <div class="selection-field">
                    <label class="form-label" for="platoon-days">Days Off</label>
                    <select id="platoon-days" class="form-select" @bind="_selection.PlatoonDaysOff" @bind:after="UpdatePreview">
                        <option value="@PlatoonDaysOffOption.MonTue">Mon/Tue</option>
                        <option value="@PlatoonDaysOffOption.ThuFri">Thu/Fri</option>
                    </select>
                </div>
            }
            else if (_selection.ScheduleType == ScheduleType.RotatingFourByTen)
            {
                <div class="selection-field">
                    <label class="form-label" for="rotating-days">Starting Days Off</label>
                    <select id="rotating-days" class="form-select" @bind="_selection.RotatingOffStartDay" @bind:after="UpdatePreview">
                        @foreach (var day in _rotatingOffDays)
                        {
                            <option value="@day">@GetRotatingOffLabel(day)</option>
                        }
                    </select>
                </div>
            }
        </div>

        <div class="selection-actions">
            <button class="btn btn-primary save-btn" type="button" @onclick="SaveSelection">Save Selection</button>
            @if (!string.IsNullOrWhiteSpace(_statusMessage))
            {
                <span class="status-msg">@_statusMessage</span>
            }
        </div>
    </div>
</div>

@if (_yearSchedule.Count > 0)
{
    <div class="app-card p-4 mb-4">
        <h5 class="card-title mb-4">Yearly Schedule View</h5>
        <div class="table-responsive">
            <table class="table table-sm align-middle schedule-table app-table">
                <thead>
                    <tr>
                        <th>Week of</th>
                        @foreach (var name in _dayNames)
                        {
                            <th>@name[..3]</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var week in _yearSchedule)
                    {
                        <tr>
                            <td class="text-nowrap fw-bold text-muted">@week.WeekStart.ToString("MMM dd")</td>
                            @foreach (var day in week.Days)
                            {
                                <td class="p-2">
                                    <div class="small text-muted mb-1">@day.Date.ToString("MM/dd")</div>
                                    @if (!day.IsActive)
                                    {
                                        <span class="status-chip status-chip--empty">-</span>
                                    }
                                    else if (day.IsWorkDay)
                                    {
                                        <span class="status-chip status-chip--work">Work</span>
                                    }
                                    else
                                    {
                                        <span class="status-chip status-chip--off">Off</span>
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private static readonly string[] _dayNames =
    {
        "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"
    };

    private readonly ScheduleSelectionModel _selection = new();
    private readonly RotatingOffStartDay[] _rotatingOffDays = Enum.GetValues<RotatingOffStartDay>();
    private IReadOnlyList<WeekSchedule> _yearSchedule = Array.Empty<WeekSchedule>();
    private string? _statusMessage;

    protected override void OnInitialized()
    {
        var selection = ScheduleService.GetSelection();
        _selection.ScheduleType = selection.ScheduleType;
        _selection.ShiftType = selection.ShiftType;
        _selection.StartMonth = new DateTime(selection.StartDate.Year, selection.StartDate.Month, 1);
        _selection.PlatoonDaysOff = selection.PlatoonDaysOff;
        _selection.RotatingOffStartDay = selection.RotatingOffStartDay;

        UpdatePreview();
    }

    private void SaveSelection()
    {
        ScheduleService.UpdateSelection(new ScheduleSelection(
            _selection.ScheduleType,
            _selection.ShiftType,
            GetStartDate(),
            _selection.PlatoonDaysOff,
            _selection.RotatingOffStartDay));

        _statusMessage = "Schedule saved.";
        UpdatePreview();
    }

    private void OnMonthChanged(ChangeEventArgs args)
    {
        if (args.Value is string value && DateTime.TryParseExact(value, "yyyy-MM", CultureInfo.InvariantCulture, DateTimeStyles.None, out var parsed))
        {
            _selection.StartMonth = new DateTime(parsed.Year, parsed.Month, 1);
            UpdatePreview();
        }
    }

    private void UpdatePreview()
    {
        ScheduleService.UpdateSelection(new ScheduleSelection(
            _selection.ScheduleType,
            _selection.ShiftType,
            GetStartDate(),
            _selection.PlatoonDaysOff,
            _selection.RotatingOffStartDay));

        _yearSchedule = ScheduleService.BuildYearSchedule(GetStartDate());
        _statusMessage = null;
    }

    private DateOnly GetStartDate()
    {
        return new DateOnly(_selection.StartMonth.Year, _selection.StartMonth.Month, 1);
    }

    private static string GetRotatingOffLabel(RotatingOffStartDay startDay)
    {
        var startIndex = GetDayIndex(startDay);
        var midIndex = (startIndex + 1) % 7;
        var endIndex = (startIndex + 2) % 7;
        return $"{_dayNames[startIndex][..3]}/{_dayNames[midIndex][..3]}/{_dayNames[endIndex][..3]}";
    }

    private sealed class ScheduleSelectionModel
    {
        [Required]
        public ScheduleType ScheduleType { get; set; } = ScheduleType.FiveByEight;

        [Required]
        public ShiftType ShiftType { get; set; } = ShiftType.Day;

        [Required]
        public DateTime StartMonth { get; set; } = new(DateTime.Today.Year, DateTime.Today.Month, 1);

        [Required]
        public PlatoonDaysOffOption PlatoonDaysOff { get; set; } = PlatoonDaysOffOption.MonTue;

        [Required]
        public RotatingOffStartDay RotatingOffStartDay { get; set; } = RotatingOffStartDay.Monday;
    }

    private static int GetDayIndex(RotatingOffStartDay day)
    {
        return day switch
        {
            RotatingOffStartDay.Monday => 0,
            RotatingOffStartDay.Tuesday => 1,
            RotatingOffStartDay.Wednesday => 2,
            RotatingOffStartDay.Thursday => 3,
            RotatingOffStartDay.Friday => 4,
            RotatingOffStartDay.Saturday => 5,
            RotatingOffStartDay.Sunday => 6,
            _ => 0
        };
    }
}
