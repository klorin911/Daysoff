@page "/payroll"
@using DaysOff.Models
@using DaysOff.Services
@inject ScheduleService ScheduleService
@inject IJSRuntime JsRuntime

<PageTitle>Payroll Export</PageTitle>

<div class="page-header">
    <h2>Payroll Export</h2>
    <p class="text-muted">Review weekly totals and download a CSV for payroll processing.</p>
</div>

<div class="card app-card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
                <label class="form-label">Week Starting</label>
                <InputDate class="form-control" @bind-Value="_weekStartInput" @onchange="_ => Refresh()" />
            </div>
            <div class="col-12 col-md-4">
                <button class="btn btn-primary" @onclick="DownloadCsv">Download CSV</button>
            </div>
        </div>
    </div>
</div>

<div class="card app-card">
    <div class="card-body">
        <table class="table app-table">
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Department</th>
                    <th>Total Hours</th>
                    <th>Base Pay</th>
                    <th>Differentials</th>
                    <th>Total Pay</th>
                </tr>
            </thead>
            <tbody>
                @if (_summary is not null)
                {
                    <tr>
                        <td>@_summary.EmployeeName</td>
                        <td>@_summary.Department</td>
                        <td>@_summary.TotalHours.ToString("0.##")</td>
                        <td>@_summary.BasePay.ToString("C")</td>
                        <td>@_summary.DifferentialPay.ToString("C")</td>
                        <td class="fw-semibold">@_summary.TotalPay.ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private DateTime _weekStartInput = DateTime.Today;
    private EmployeePayrollSummary? _summary;

    protected override void OnInitialized()
    {
        Refresh();
    }

    private void Refresh()
    {
        var weekStart = GetWeekStart(DateOnly.FromDateTime(_weekStartInput));
        _summary = ScheduleService.BuildPayrollSummary(weekStart);
    }

    private async Task DownloadCsv()
    {
        var weekStart = GetWeekStart(DateOnly.FromDateTime(_weekStartInput));
        var csv = ScheduleService.BuildPayrollCsv(weekStart);
        var fileName = $"payroll-{weekStart:yyyyMMdd}.csv";
        await JsRuntime.InvokeVoidAsync("downloadFile", fileName, csv);
    }

    private static DateOnly GetWeekStart(DateOnly date)
    {
        var offset = ((int)date.DayOfWeek + 6) % 7;
        return date.AddDays(-offset);
    }
}
