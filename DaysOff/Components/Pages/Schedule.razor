@page "/schedule"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@using DaysOff.Models
@using DaysOff.Services
@inject ScheduleService ScheduleService

<PageTitle>Schedule Selection</PageTitle>

<div class="page-header">
    <h2>Schedule Selection</h2>
    <p class="text-muted">Select your schedule, shift, and start month to preview the year ahead.</p>
</div>

<div class="card app-card mb-4">
    <div class="card-body">
        <EditForm Model="_selection" OnValidSubmit="SaveSelection" FormName="schedule-selection">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label">Schedule</label>
                    <select class="form-select" @onchange="OnScheduleChanged" value="@_selection.ScheduleType">
                        <option value="@ScheduleType.FiveByEight">5x8</option>
                        <option value="@ScheduleType.PlatoonTen">Platoon 10s</option>
                        <option value="@ScheduleType.RotatingFourByTen">Rotating 4x10</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Shift</label>
                    <select class="form-select" @onchange="OnShiftChanged" value="@_selection.ShiftType">
                        <option value="@ShiftType.Day">Day</option>
                        <option value="@ShiftType.Swing">Swing</option>
                        <option value="@ShiftType.Mid">Mid</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Start Month</label>
                    <MudDatePicker Class="month-picker"
                                   Date="_selection.StartMonth"
                                   DateChanged="OnMonthChanged"
                                   DateFormat="MMMM yyyy"
                                   OpenTo="OpenTo.Month"
                                   FixDay="1"
                                   AutoClose="true"
                                   PickerVariant="PickerVariant.Dialog"
                                   Variant="Variant.Outlined"
                                   Editable="false"
                                   Adornment="Adornment.End"
                                   AdornmentIcon="@Icons.Material.Filled.CalendarMonth" />
                </div>
            </div>

            @if (_selection.ScheduleType == ScheduleType.PlatoonTen)
            {
                <div class="row g-3 mt-1">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Days Off</label>
                        <select class="form-select" @onchange="OnPlatoonDaysOffChanged" value="@_selection.PlatoonDaysOff">
                            <option value="@PlatoonDaysOffOption.MonTue">Mon/Tue</option>
                            <option value="@PlatoonDaysOffOption.ThuFri">Thu/Fri</option>
                        </select>
                    </div>
                </div>
            }
            else if (_selection.ScheduleType == ScheduleType.RotatingFourByTen)
            {
                <div class="row g-3 mt-1">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Starting Days Off</label>
                        <select class="form-select" @onchange="OnRotatingOffStartChanged" value="@_selection.RotatingOffStartDay">
                            @foreach (var day in _rotatingOffDays)
                            {
                                <option value="@day">@GetRotatingOffLabel(day)</option>
                            }
                        </select>
                    </div>
                </div>
            }

            <div class="mt-4 d-flex gap-2 align-items-center">
                <button class="btn btn-primary" type="submit">Save Selection</button>
                @if (!string.IsNullOrWhiteSpace(_statusMessage))
                {
                    <span class="status-text">@_statusMessage</span>
                }
            </div>
        </EditForm>
    </div>
</div>

@if (_yearSchedule.Count > 0)
{
    <div class="row g-4">
        <div class="col-12">
            <div class="card app-card">
                <div class="card-body">
                    <h5 class="card-title">Yearly Schedule View</h5>
                    <div class="table-responsive mt-3">
                        <table class="table table-sm align-middle schedule-table app-table">
                            <thead>
                                <tr>
                                    <th>Week of</th>
                                    @foreach (var name in _dayNames)
                                    {
                                        <th>@name[..3]</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var week in _yearSchedule)
                                {
                                    <tr>
                                        <td class="text-nowrap">@week.WeekStart.ToString("MMM dd")</td>
                                        @foreach (var day in week.Days)
                                        {
                                            <td class="p-2">
                                                <div class="small text-muted">@day.Date.ToString("MM/dd")</div>
                                                @if (!day.IsActive)
                                                {
                                                    <span class="status-chip status-chip--empty">-</span>
                                                }
                                                else if (day.IsWorkDay)
                                                {
                                                    <span class="status-chip status-chip--work">Work</span>
                                                }
                                                else
                                                {
                                                    <span class="status-chip status-chip--off">Off</span>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private static readonly string[] _dayNames =
    {
        "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"
    };

    private readonly ScheduleSelectionModel _selection = new();
    private readonly RotatingOffStartDay[] _rotatingOffDays = Enum.GetValues<RotatingOffStartDay>();
    private IReadOnlyList<WeekSchedule> _yearSchedule = Array.Empty<WeekSchedule>();
    private string? _statusMessage;

    protected override void OnInitialized()
    {
        var selection = ScheduleService.GetSelection();
        _selection.ScheduleType = selection.ScheduleType;
        _selection.ShiftType = selection.ShiftType;
        _selection.StartMonth = new DateTime(selection.StartDate.Year, selection.StartDate.Month, 1);
        _selection.PlatoonDaysOff = selection.PlatoonDaysOff;
        _selection.RotatingOffStartDay = selection.RotatingOffStartDay;

        UpdatePreview();
    }

    private void SaveSelection()
    {
        ScheduleService.UpdateSelection(new ScheduleSelection(
            _selection.ScheduleType,
            _selection.ShiftType,
            GetStartDate(),
            _selection.PlatoonDaysOff,
            _selection.RotatingOffStartDay));

        _statusMessage = "Schedule saved.";
        UpdatePreview();
    }

    private void OnScheduleChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<ScheduleType>(e.Value?.ToString(), out var scheduleType))
        {
            _selection.ScheduleType = scheduleType;
            UpdatePreview();
        }
    }

    private void OnShiftChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<ShiftType>(e.Value?.ToString(), out var shiftType))
        {
            _selection.ShiftType = shiftType;
            UpdatePreview();
        }
    }

    private void OnMonthChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            _selection.StartMonth = new DateTime(date.Value.Year, date.Value.Month, 1);
            UpdatePreview();
        }
    }

    private void OnPlatoonDaysOffChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<PlatoonDaysOffOption>(e.Value?.ToString(), out var daysOff))
        {
            _selection.PlatoonDaysOff = daysOff;
            UpdatePreview();
        }
    }

    private void OnRotatingOffStartChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<RotatingOffStartDay>(e.Value?.ToString(), out var startDay))
        {
            _selection.RotatingOffStartDay = startDay;
            UpdatePreview();
        }
    }

    private void UpdatePreview()
    {
        ScheduleService.UpdateSelection(new ScheduleSelection(
            _selection.ScheduleType,
            _selection.ShiftType,
            GetStartDate(),
            _selection.PlatoonDaysOff,
            _selection.RotatingOffStartDay));

        _yearSchedule = ScheduleService.BuildYearSchedule(GetStartDate());
        _statusMessage = null;
    }

    private DateOnly GetStartDate()
    {
        return new DateOnly(_selection.StartMonth.Year, _selection.StartMonth.Month, 1);
    }

    private static string GetRotatingOffLabel(RotatingOffStartDay startDay)
    {
        var startIndex = GetDayIndex(startDay);
        var midIndex = (startIndex + 1) % 7;
        var endIndex = (startIndex + 2) % 7;
        return $"{_dayNames[startIndex][..3]}/{_dayNames[midIndex][..3]}/{_dayNames[endIndex][..3]}";
    }

    private sealed class ScheduleSelectionModel
    {
        [Required]
        public ScheduleType ScheduleType { get; set; } = ScheduleType.FiveByEight;

        [Required]
        public ShiftType ShiftType { get; set; } = ShiftType.Day;

        [Required]
        public DateTime StartMonth { get; set; } = new(DateTime.Today.Year, DateTime.Today.Month, 1);

        [Required]
        public PlatoonDaysOffOption PlatoonDaysOff { get; set; } = PlatoonDaysOffOption.MonTue;

        [Required]
        public RotatingOffStartDay RotatingOffStartDay { get; set; } = RotatingOffStartDay.Monday;
    }

    private static int GetDayIndex(RotatingOffStartDay day)
    {
        return day switch
        {
            RotatingOffStartDay.Monday => 0,
            RotatingOffStartDay.Tuesday => 1,
            RotatingOffStartDay.Wednesday => 2,
            RotatingOffStartDay.Thursday => 3,
            RotatingOffStartDay.Friday => 4,
            RotatingOffStartDay.Saturday => 5,
            RotatingOffStartDay.Sunday => 6,
            _ => 0
        };
    }
}
